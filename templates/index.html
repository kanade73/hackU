<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</title>
  <style>
    .task-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .timer-info {
      font-size: 0.9em;
      color: #555;
    }
    label.completed {
      text-decoration: line-through;
      color: gray;
    }
    .start-btn {
      padding: 6px 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      text-decoration: none;
      cursor: pointer;
    }
    .start-btn:hover {
      background-color: #45a049;
    }
    /* ç”»é¢é·ç§»ç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .nav-btn {
      display: inline-block;
      padding: 8px 16px;
      background: #2a7ae2;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      margin-top: 15px;
    }
    .nav-btn:hover {
      background: #165cbd;
    }
    h2 {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>ä»Šæ—¥ã®æ™‚é–“å‰²</h1>
  <ul>
    {% for slot in timetable %}
      <li>{{ slot.period }}é™ï¼š{{ slot.subject }}</li>
    {% else %}
      <li>æ™‚é–“å‰²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</li>
    {% endfor %}
  </ul>

  <a href="{{ url_for('edit_timetable') }}">ğŸ•’ æ™‚é–“å‰²ã‚’ç·¨é›†ã™ã‚‹</a><br>
  <!-- åˆæœŸè¨­å®šç”»é¢ã¸ã®é·ç§»ç”¨ãƒœã‚¿ãƒ³ -->
  <a href="{{ url_for('setup') }}" class="nav-btn">åˆæœŸè¨­å®šãƒšãƒ¼ã‚¸ã¸</a>

  <p>setup URL: {{ url_for('setup') }}</p>
  <p>edit_timetable URL: {{ url_for('edit_timetable') }}</p>
  <p>add_task URL: {{ url_for('add_task') }}</p>

  <h2>ä»Šæ—¥ã‚„ã‚‹ã“ã¨</h2>
  <ul>
    {% for task in tasks_today %}
      <li>
        <div class="task-row">
          {% set completed = task.time_spent is not none %}
          <input type="checkbox"
                 class="complete-checkbox"
                 data-task-id="{{ task.id }}"
                 {% if completed %}checked disabled{% endif %}>
          <label id="task_label_{{ task.id }}"
                 class="{% if completed %}completed{% endif %}">
            {{ task.subject }}ï¼ˆ{{ task.category }}ï¼‰:
            {% if completed %}
              å®Œäº†ï¼ˆå®Ÿç¸¾ {{ task.time_spent }}åˆ†ï¼‰
            {% else %}
              äºˆæ¸¬æ™‚é–“ {{ task.predicted_time }}åˆ†
            {% endif %}
          </label>
          <span class="timer-info" id="timer_info_{{ task.id }}"></span>
          {% if not completed %}
            <a href="{{ url_for('start_task', task_id=task.id) }}" class="start-btn">é–‹å§‹ï¼å†é–‹</a>
          {% endif %}
        </div>
      </li>
    {% else %}
      <li>æœ¬æ—¥ã‚„ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
    {% endfor %}
  </ul>

  <h2>æœªå®Œäº†ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
  <ul>
    {% for task in tasks_remaining %}
      <li>
        <div class="task-row">
          {% set completed = task.time_spent is not none %}
          <input type="checkbox"
                 class="complete-checkbox"
                 data-task-id="{{ task.id }}"
                 {% if completed %}checked disabled{% endif %}>
          <label id="task_label_{{ task.id }}"
                 class="{% if completed %}completed{% endif %}">
            {{ task.subject }}ï¼ˆ{{ task.category }}ï¼‰:
            {% if completed %}
              å®Œäº†ï¼ˆå®Ÿç¸¾ {{ task.time_spent }}åˆ†ï¼‰
            {% else %}
              äºˆæ¸¬æ™‚é–“ {{ task.predicted_time }}åˆ†
            {% endif %}
          </label>
          <span class="timer-info" id="timer_info_{{ task.id }}"></span>
          {% if not completed %}
            <a href="{{ url_for('start_task', task_id=task.id) }}" class="start-btn">é–‹å§‹ï¼å†é–‹</a>
          {% endif %}
        </div>
      </li>
    {% else %}
      <li>æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
    {% endfor %}
  </ul>

  <a href="{{ url_for('add_task') }}">ï¼‹ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹</a>

  <script>
    // å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll(".complete-checkbox").forEach(checkbox => {
      checkbox.addEventListener("change", () => {
        const taskId = checkbox.dataset.taskId;
        const label = document.getElementById("task_label_" + taskId);
        if (checkbox.checked) {
          label.classList.add("completed");
          localStorage.setItem("taskCompleted_" + taskId, "true");
        } else {
          label.classList.remove("completed");
          localStorage.removeItem("taskCompleted_" + taskId);
        }
      });
    });

    // å®Œäº†çŠ¶æ…‹ã®å¾©å…ƒ
    function applyCompletionState() {
      document.querySelectorAll(".complete-checkbox").forEach(checkbox => {
        const taskId = checkbox.dataset.taskId;
        const label = document.getElementById("task_label_" + taskId);
        if (localStorage.getItem("taskCompleted_" + taskId) === "true") {
          checkbox.checked = true;
          label.classList.add("completed");
        }
      });
    }

    // ã‚¿ã‚¤ãƒãƒ¼æƒ…å ±æ›´æ–°
    function updateAllTimerInfo() {
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith("timerState_")) continue;
        try {
          const state = JSON.parse(localStorage.getItem(key));
          if (state && state.task_id) {
            let totalSeconds = state.elapsedSeconds || 0;
            if (state.running && state.startTime) {
              totalSeconds += Math.floor((Date.now() - state.startTime) / 1000);
            }
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const display = hours > 0 ?
              `ï¼ˆç¾åœ¨ ${hours}æ™‚é–“ ${minutes}åˆ†é ‘å¼µã£ã¦ã„ã¾ã™ï¼‰` :
              `ï¼ˆç¾åœ¨ ${minutes}åˆ†é ‘å¼µã£ã¦ã„ã¾ã™ï¼‰`;
            const span = document.getElementById("timer_info_" + state.task_id);
            if (span) span.textContent = display;
          }
        } catch (e) {
          console.error("ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã®æ›´æ–°å¤±æ•—:", e);
        }
      }
    }

    applyCompletionState();
    setInterval(updateAllTimerInfo, 1000);
  </script>
</body>
</html>
