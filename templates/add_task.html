<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¿ã‚¹ã‚¯è¿½åŠ </title>
  <style>
    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .menu-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #2a7ae2;
      padding: 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .menu-btn {
      margin: 0 15px;
      text-decoration: none;
      color: #fff;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .menu-icon {
      font-size: 1.5em;
    }
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼åˆ†ã®ä½™ç™½ã‚’ç¢ºä¿ */
    .content {
      padding-top: 60px;
    }
    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š */
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    input, select, button {
      width: 100%;
      padding: 0.5em;
      margin-top: 0.2em;
      box-sizing: border-box;
    }
    button {
      margin-top: 1.5em;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨ãƒœã‚¿ãƒ³ */
    .inline-btn {
      width: auto;
      display: inline-block;
      margin-top: 0.2em;
      margin-left: 0.5em;
    }
    /* æˆ»ã‚‹ãƒªãƒ³ã‚¯ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .back-link {
      margin-top: 2em;
      display: block;
    }
    /* å‰å›ã®å…¥åŠ›ã‚’åæ˜ ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .repeat-btn {
      margin-top: 1em;
      background-color: #008CBA;
    }
    /* æ™‚é–“å‰²ã‚°ãƒªãƒƒãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .timetable-grid {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
    }
    .timetable-grid th,
    .timetable-grid td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    .timetable-grid th {
      background-color: #f2f2f2;
    }
    .timetable-cell {
      cursor: pointer;
      background-color: #fafafa;
      transition: background-color 0.2s;
    }
    .timetable-cell:hover {
      background-color: #e0f0ff;
    }
  </style>
</head>
<body>
  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ -->
  <div class="menu-bar">
    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <a href="{{ url_for('index') }}" class="menu-btn" title="ãƒ¡ã‚¤ãƒ³ç”»é¢">
      <span class="menu-icon">ğŸ </span>
      <span class="menu-text">ãƒ¡ã‚¤ãƒ³</span>
    </a>
    <!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ç”»é¢ -->
    <a href="{{ url_for('add_task') }}" class="menu-btn" title="ã‚¿ã‚¹ã‚¯è¿½åŠ ">
      <span class="menu-icon">â•</span>
      <span class="menu-text">è¿½åŠ </span>
    </a>
    <!-- è¨­å®šç”»é¢ -->
    <a href="{{ url_for('setup') }}" class="menu-btn" title="è¨­å®š">
      <span class="menu-icon">âš™ï¸</span>
      <span class="menu-text">è¨­å®š</span>
    </a>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ† -->
  <div class="content">
    <h1>æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h1>
    <!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="taskForm" action="{{ url_for('add_task') }}" method="POST">
      <label for="subject">ç§‘ç›®</label>
      <input type="text" name="subject" id="subject" required>

      <!-- æ™‚é–“å‰²ã‚°ãƒªãƒƒãƒ‰ -->
      <h2>ä»Šæ—¥ã®æ™‚é–“å‰²ã‹ã‚‰ç§‘ç›®ã‚’é¸æŠ</h2>
      {% if timetable_grid %}
      <table class="timetable-grid">
        <thead>
          <tr>
            <th>é™ï¼æ›œæ—¥</th>
            <th>æœˆ</th>
            <th>ç«</th>
            <th>æ°´</th>
            <th>æœ¨</th>
            <th>é‡‘</th>
          </tr>
        </thead>
        <tbody>
          {% for period in range(1, 6) %}
          <tr>
            <th>{{ period }}é™</th>
            {% for day in range(0, 5) %}
            <td class="timetable-cell" onclick="selectSubject(this)">
              {% if timetable_grid[period - 1][day] %}
                {{ timetable_grid[period - 1][day] }}
              {% else %}
                &nbsp;
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>æ™‚é–“å‰²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {% endif %}

      <!-- ã‚«ãƒ†ã‚´ãƒªï¼ˆèª²é¡Œã®ç¨®é¡ï¼‰ã‚’é¸æŠåˆ¶ã«å¤‰æ›´ -->
      <label for="category">èª²é¡Œã®ç¨®é¡</label>
      <select name="category" id="category" required onblur="saveCategory()">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ãƒ¬ãƒãƒ¼ãƒˆ">ãƒ¬ãƒãƒ¼ãƒˆ</option>
        <option value="å•é¡Œæ¼”ç¿’">å•é¡Œæ¼”ç¿’</option>
        <option value="ãƒ—ãƒ¬ã‚¼ãƒ³æº–å‚™">ãƒ—ãƒ¬ã‚¼ãƒ³æº–å‚™</option>
        <option value="èª¿ã¹å­¦ç¿’">èª¿ã¹å­¦ç¿’</option>
        <option value="ã‚°ãƒ«ãƒ¼ãƒ—ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³">ã‚°ãƒ«ãƒ¼ãƒ—ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³</option>
        <option value="è«–æ–‡åŸ·ç­†">è«–æ–‡åŸ·ç­†</option>
        <option value="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼ç”»">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼ç”»</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>

      <label for="difficulty">ã‚„ã‚ŠãŸããªã•ï¼ˆ1ã€œ5ï¼‰</label>
      <select name="difficulty" id="difficulty" required>
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="1">1ï¼ˆã‚„ã‚Šã‚„ã™ã„ï¼‰</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5ï¼ˆã‚„ã‚ŠãŸããªã„ï¼‰</option>
      </select>

      <label for="due_date">ç· åˆ‡æ—¥</label>
      <div style="display: flex; align-items: center;">
        <input type="date" name="due_date" id="due_date" required onclick="openDatePicker(event)">
        <!-- ä¸€é€±é–“å¾Œãƒœã‚¿ãƒ³ -->
        <button type="button" class="inline-btn" onclick="setWeekLater()">ä¸€é€±é–“å¾Œ</button>
      </div>

      <!-- ã€Œå‰ã¨åŒã˜ã€ãƒœã‚¿ãƒ³ï¼ˆç¾åœ¨ã®ç§‘ç›®ã”ã¨ã«å‰å›ã®æƒ…å ±ã‚’åæ˜ ï¼‰ -->
      <button type="button" class="repeat-btn" onclick="fillPreviousTask()">å‰ã¨åŒã˜</button>

      <button type="submit">è¿½åŠ ã™ã‚‹</button>
    </form>

    <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
    <a href="{{ url_for('index') }}" class="back-link">â† ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
  </div>

  <script>
    // ç§‘ç›®æ¬„ã«ã€ã‚°ãƒªãƒƒãƒ‰å†…ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å†…å®¹ã‚’åæ˜ ã™ã‚‹
    function selectSubject(cell) {
      var subject = cell.textContent.trim();
      if (subject === "") return;
      document.getElementById("subject").value = subject;
    }

    // ç§‘ç›®ã”ã¨ã®å‰å›ã®æƒ…å ±ï¼ˆã‚«ãƒ†ã‚´ãƒªã€é›£æ˜“åº¦ï¼‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹
    function saveCategory() {
      var subject = document.getElementById("subject").value.trim();
      if (subject === "") return; // ç§‘ç›®ãŒç©ºãªã‚‰ä¿å­˜ã—ãªã„
      var category = document.getElementById("category").value;
      var difficulty = document.getElementById("difficulty").value;
      var details = {
        category: category,
        difficulty: difficulty
      };
      localStorage.setItem("last_details_" + subject, JSON.stringify(details));
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ã‚‚ã€ç¾åœ¨ã®ç§‘ç›®ã”ã¨ã®æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹
    document.getElementById("taskForm").addEventListener("submit", function() {
      var subject = document.getElementById("subject").value.trim();
      var category = document.getElementById("category").value;
      var difficulty = document.getElementById("difficulty").value;
      var details = {
        category: category,
        difficulty: difficulty
      };
      localStorage.setItem("last_details_" + subject, JSON.stringify(details));
    });

    // ã€Œå‰ã¨åŒã˜ã€ãƒœã‚¿ãƒ³ï¼šç¾åœ¨ã®ç§‘ç›®ã‚’ã‚­ãƒ¼ã«ã—ã€å‰å›ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã‚’åæ˜ ã™ã‚‹ï¼ˆç· åˆ‡æ—¥ã¯ä¸€é€±é–“å¾Œã«è¨­å®šï¼‰
    function fillPreviousTask() {
      var subject = document.getElementById("subject").value.trim();
      if (subject === "") {
        alert("ã¾ãšç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      var stored = localStorage.getItem("last_details_" + subject);
      if (stored) {
        var details = JSON.parse(stored);
        if (details.category) {
          document.getElementById("category").value = details.category;
        }
        if (details.difficulty) {
          document.getElementById("difficulty").value = details.difficulty;
        }
      } else {
        alert("ã“ã®ç§‘ç›®ã®å‰å›ã®æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
      // ç· åˆ‡æ—¥ã‚’ä»Šæ—¥ã‹ã‚‰ä¸€é€±é–“å¾Œã«è¨­å®šã™ã‚‹
      var today = new Date();
      today.setDate(today.getDate() + 7);
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var dd = String(today.getDate()).padStart(2, '0');
      document.getElementById("due_date").value = `${yyyy}-${mm}-${dd}`;
    }

    // æ—¥ä»˜å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã€ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚ã‚Œã°ï¼‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
    function openDatePicker(e) {
      var dateInput = e.target;
      if (dateInput.showPicker) {
        dateInput.showPicker();
      }
    }

    // ã€Œä¸€é€±é–“å¾Œã€ãƒœã‚¿ãƒ³ï¼šç· åˆ‡æ—¥ã‚’ä»Šæ—¥ã‹ã‚‰ä¸€é€±é–“å¾Œã«è¨­å®šã™ã‚‹
    function setWeekLater() {
      var today = new Date();
      today.setDate(today.getDate() + 7);
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var dd = String(today.getDate()).padStart(2, '0');
      document.getElementById("due_date").value = `${yyyy}-${mm}-${dd}`;
    }
  </script>
</body>
</html>
