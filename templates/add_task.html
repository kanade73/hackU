<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>タスク追加</title>
  <style>
    /* メニューバー関連のスタイル */
    .menu-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #2a7ae2;
      padding: 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .menu-btn {
      margin: 0 15px;
      text-decoration: none;
      color: #fff;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .menu-icon {
      font-size: 1.5em;
    }
    /* コンテンツ部はメニューバー分の余白を確保 */
    .content {
      padding-top: 60px;
    }
    /* ページ全体のレイアウトとフォーム設定 */
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    input, select, button {
      width: 100%;
      padding: 0.5em;
      margin-top: 0.2em;
      box-sizing: border-box;
    }
    button {
      margin-top: 1.5em;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    /* インライン表示用ボタン */
    .inline-btn {
      width: auto;
      display: inline-block;
      margin-top: 0.2em;
      margin-left: 0.5em;
    }
    /* 戻るリンク用スタイル */
    .back-link {
      margin-top: 2em;
      display: block;
    }
    /* 前回の入力を反映するボタンのスタイル */
    .repeat-btn {
      margin-top: 1em;
      background-color: #008CBA;
    }
    /* 時間割グリッド用スタイル */
    .timetable-grid {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
    }
    .timetable-grid th,
    .timetable-grid td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    .timetable-grid th {
      background-color: #f2f2f2;
    }
    .timetable-cell {
      cursor: pointer;
      background-color: #fafafa;
      transition: background-color 0.2s;
    }
    .timetable-cell:hover {
      background-color: #e0f0ff;
    }
  </style>
</head>
<body>
  <!-- メニューバー -->
  <div class="menu-bar">
    <!-- メイン画面 -->
    <a href="{{ url_for('index') }}" class="menu-btn" title="メイン画面">
      <span class="menu-icon">🏠</span>
      <span class="menu-text">メイン</span>
    </a>
    <!-- タスク追加画面 -->
    <a href="{{ url_for('add_task') }}" class="menu-btn" title="タスク追加">
      <span class="menu-icon">➕</span>
      <span class="menu-text">追加</span>
    </a>
    <!-- 設定画面 -->
    <a href="{{ url_for('setup') }}" class="menu-btn" title="設定">
      <span class="menu-icon">⚙️</span>
      <span class="menu-text">設定</span>
    </a>
  </div>

  <!-- コンテンツ部分 -->
  <div class="content">
    <h1>新しいタスクを追加</h1>
    <!-- タスク追加フォーム -->
    <form id="taskForm" action="{{ url_for('add_task') }}" method="POST">
      <label for="subject">科目</label>
      <input type="text" name="subject" id="subject" required>

      <!-- 時間割グリッド -->
      <h2>今日の時間割から科目を選択</h2>
      {% if timetable_grid %}
      <table class="timetable-grid">
        <thead>
          <tr>
            <th>限／曜日</th>
            <th>月</th>
            <th>火</th>
            <th>水</th>
            <th>木</th>
            <th>金</th>
          </tr>
        </thead>
        <tbody>
          {% for period in range(1, 6) %}
          <tr>
            <th>{{ period }}限</th>
            {% for day in range(0, 5) %}
            <td class="timetable-cell" onclick="selectSubject(this)">
              {% if timetable_grid[period - 1][day] %}
                {{ timetable_grid[period - 1][day] }}
              {% else %}
                &nbsp;
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>時間割が登録されていません。</p>
      {% endif %}

      <!-- カテゴリ（課題の種類）を選択制に変更 -->
      <label for="category">課題の種類</label>
      <select name="category" id="category" required onblur="saveCategory()">
        <option value="">選択してください</option>
        <option value="レポート">レポート</option>
        <option value="問題演習">問題演習</option>
        <option value="プレゼン準備">プレゼン準備</option>
        <option value="調べ学習">調べ学習</option>
        <option value="グループディスカッション">グループディスカッション</option>
        <option value="論文執筆">論文執筆</option>
        <option value="プロジェクト企画">プロジェクト企画</option>
        <option value="その他">その他</option>
      </select>

      <label for="difficulty">やりたくなさ（1〜5）</label>
      <select name="difficulty" id="difficulty" required>
        <option value="">選択してください</option>
        <option value="1">1（やりやすい）</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5（やりたくない）</option>
      </select>

      <label for="due_date">締切日</label>
      <div style="display: flex; align-items: center;">
        <input type="date" name="due_date" id="due_date" required onclick="openDatePicker(event)">
        <!-- 一週間後ボタン -->
        <button type="button" class="inline-btn" onclick="setWeekLater()">一週間後</button>
      </div>

      <!-- 「前と同じ」ボタン（現在の科目ごとに前回の情報を反映） -->
      <button type="button" class="repeat-btn" onclick="fillPreviousTask()">前と同じ</button>

      <button type="submit">追加する</button>
    </form>

    <!-- トップページへ戻るリンク -->
    <a href="{{ url_for('index') }}" class="back-link">← トップに戻る</a>
  </div>

  <script>
    // 科目欄に、グリッド内のセルをクリックしたときの内容を反映する
    function selectSubject(cell) {
      var subject = cell.textContent.trim();
      if (subject === "") return;
      document.getElementById("subject").value = subject;
    }

    // 科目ごとの前回の情報（カテゴリ、難易度）をローカルストレージに保存する
    function saveCategory() {
      var subject = document.getElementById("subject").value.trim();
      if (subject === "") return; // 科目が空なら保存しない
      var category = document.getElementById("category").value;
      var difficulty = document.getElementById("difficulty").value;
      var details = {
        category: category,
        difficulty: difficulty
      };
      localStorage.setItem("last_details_" + subject, JSON.stringify(details));
    }

    // フォーム送信時にも、現在の科目ごとの情報を保存する
    document.getElementById("taskForm").addEventListener("submit", function() {
      var subject = document.getElementById("subject").value.trim();
      var category = document.getElementById("category").value;
      var difficulty = document.getElementById("difficulty").value;
      var details = {
        category: category,
        difficulty: difficulty
      };
      localStorage.setItem("last_details_" + subject, JSON.stringify(details));
    });

    // 「前と同じ」ボタン：現在の科目をキーにし、前回保存された情報を反映する（締切日は一週間後に設定）
    function fillPreviousTask() {
      var subject = document.getElementById("subject").value.trim();
      if (subject === "") {
        alert("まず科目を選択してください。");
        return;
      }
      var stored = localStorage.getItem("last_details_" + subject);
      if (stored) {
        var details = JSON.parse(stored);
        if (details.category) {
          document.getElementById("category").value = details.category;
        }
        if (details.difficulty) {
          document.getElementById("difficulty").value = details.difficulty;
        }
      } else {
        alert("この科目の前回の情報が保存されていません。");
      }
      // 締切日を今日から一週間後に設定する
      var today = new Date();
      today.setDate(today.getDate() + 7);
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var dd = String(today.getDate()).padStart(2, '0');
      document.getElementById("due_date").value = `${yyyy}-${mm}-${dd}`;
    }

    // 日付入力欄をクリックした際、（対応ブラウザであれば）カレンダーピッカーを表示する
    function openDatePicker(e) {
      var dateInput = e.target;
      if (dateInput.showPicker) {
        dateInput.showPicker();
      }
    }

    // 「一週間後」ボタン：締切日を今日から一週間後に設定する
    function setWeekLater() {
      var today = new Date();
      today.setDate(today.getDate() + 7);
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var dd = String(today.getDate()).padStart(2, '0');
      document.getElementById("due_date").value = `${yyyy}-${mm}-${dd}`;
    }
  </script>
</body>
</html>
